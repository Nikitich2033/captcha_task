# Создание REST-сервиса для оптического распознавания символов CAPTCHA с использованием Keras

# Запуск файлов

Файлы 1-5 по очереди скачивают изображения капчи, обрабатывают, сортируют датасет по папкам по числам и затем по папкам train и test. Для сортировки цифр по папкам требуется установка Tesseract OCR. 

Для тестирования REST сервиса нужно создать модель с помощью файла train_mnist_model.ipynb, запустить rest_captcha.py и отправлять запросы с помощью test_request.py.

Для тестирования наполнения REST сервиса без его запуска, можно использовать notebook api_script_test.ipynb, там будут отображатся обработанные скриптом цифры и предикшн самой модели.

# 1_captcha_img_download.py

Скрипт начинается с определения базового URL-адреса для главной страницы, на которой расположены изображения капчи. Он также указывает желаемое количество изображений для загрузки (`num_images`) и создает директорию с именем "captcha_imgs" (если она еще не существует) для сохранения загруженных изображений.

Затем скрипт получает количество уже сохраненных изображений в директории "captcha_imgs" с помощью функции `os.listdir`.

Далее скрипт входит в цикл `while`, который продолжается, пока количество сохраненных изображений меньше, чем `num_images`. В каждой итерации цикла создается новая сессия для загрузки изображения.

Скрипт отправляет GET-запрос на главную страницу и создает объект BeautifulSoup для разбора HTML-кода. Затем он находит изображение капчи по его id. Если изображение найдено, скрипт получает абсолютный URL изображения с помощью функции `urljoin` и отправляет GET-запрос для получения содержимого изображения. Затем изображение сохраняется с новым именем в директории "captcha_imgs", и счетчик сохраненных изображений увеличивается.

Если изображение капчи не найдено, выводится сообщение об этом.

После каждой загрузки изображения скрипт делает паузу в 1 секунду перед следующим запросом.

# 2_num_segment.py

Скрипт начинается с подготовки директории "single_digits" для сохранения отдельных символов.

Затем скрипт получает список всех файлов с изображениями в папке "captcha_imgs".

Далее происходит перебор каждого файла с изображением. Для каждого изображения выполняются следующие операции:

1. Загрузка изображения и преобразование в оттенки серого.
2. Обработка изображения:
   - Преобразование из RGB в оттенки серого.
   - Адаптивная бинаризация.
   - Оцу-бинаризация.
   - Оцу-бинаризация с гауссовым размытием.
   - Дилатация и эрозия для удаления шумов.
3. Получение отдельных символов:
   - Определение ограничивающего прямоугольника для каждого символа.
   - Сохранение каждого символа в отдельное изображение.
   - Добавление белой рамки вокруг символа.
   - Сохранение изображения символа в папку "single_digits".

В конце скрипта переменная `x` инкрементируется на ширину символа, чтобы переместиться к следующему символу в изображении. Процесс повторяется для каждого символа в изображении.

# 3_sort_by_num.py

Описание файла:

Этот файл с именем "3_sort_by_num.py" содержит Python-скрипт для сортировки отдельных цифр, распознанных на изображениях, с использованием библиотеки Tesseract OCR. 

Определяется директории, содержащие изображения (`dir_name`) и для сохранения цифр (`digits_dir`).

Скрипт получает список всех файлов в директории `dir_name` и запускает цикл для каждого файла.

Для каждого файла выполняются следующие операции:

1. Загрузка изображения с использованием OpenCV.
2. Применение OCR к изображению с помощью Tesseract OCR и получение результатов.
3. Перебор каждого распознанного символа.
4. Проверка, что символ является цифрой с уровнем уверенности выше 85.
5. Создание директории для цифры и сохранение изображения в соответствующую папку.

После сохранения каждой цифры выводится информация о сохраненной цифре, имени файла и уровне уверенности.

# 4_sort_training_data.py

Описание файла:

Этот файл с именем "4_sort_training_data.py" содержит Python-скрипт для сортировки данных обучения, разделения их на обучающую и тестовую выборки.

Скрипт начинается с указания директории, содержащей папку с цифрами (`base_dir`), а также директорий для обучающей и тестовой выборок (`train_dir` и `test_dir`).

Далее создаются директории `train` и `test`, если они не существуют.

Скрипт получает список подпапок в директории `base_dir` с помощью функции `os.listdir` и фильтрует только директории с помощью функции `os.path.isdir`.

Затем для каждой подпапки выполняются следующие операции:

1. Создание соответствующих подпапок в директориях `train` и `test`, если они не существуют.
2. Получение списка всех файлов в подпапке.
3. Вычисление количества файлов для тестовой выборки (25% от общего числа файлов).
4. Случайный выбор файлов для папки `test` с помощью функции `random.sample`.
5. Копирование выбранных файлов в подпапку `test` с помощью функции `shutil.copy`.
6. Копирование оставшихся файлов в подпапку `train` с помощью функции `shutil.copy`.

Таким образом, скрипт разделяет данные обучения на обучающую и тестовую выборки, сохраняя соответствующие файлы в соответствующих подпапках в директориях `train` и `test`.

# train_mnist_model.ipynb

Результат данного файла заключается в обучении модели для оптического распознавания символов (OCR) с использованием датасета MNIST.

Модель сохраняется локально.

# rest_captcha.py

Основной скрипт для запуска приложения и обработки запросов. Он предназначен для работы с REST API и обеспечивает функциональность обработки CAPTCHA-изображений.

Скрипт обрабатывает входящие запросы, содержащие CAPTCHA-изображения, и возвращает результат распознавания символов на изображении.

# test_request.py

Скрипт использует библиотеку `requests` для отправки POST-запроса к серверу с указанным URL. Он читает изображение CAPTCHA, кодирует его в base64 и отправляет вместе с запросом.

Полученный ответ проверяется на статус-код. Если статус-код 200, скрипт выводит распознанные цифры на экран. В противном случае, выводится сообщение об ошибке.








